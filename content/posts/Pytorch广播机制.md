+++ 
date = '2025-06-12' 
draft = false 
title = 'Pytorchå¹¿æ’­æœºåˆ¶' 
categories = ['Pytorch'] 
tags = ['Pytorch'] 
+++

## åŸºæœ¬æ¦‚å¿µ

å¹¿æ’­æ˜¯PyTorchå’ŒNumPyä¸­ä¸€ç§æ™ºèƒ½çš„ç»´åº¦æ‰©å±•æœºåˆ¶ï¼Œå…è®¸ä¸åŒå½¢çŠ¶çš„å¼ é‡è¿›è¡Œè¿ç®—ã€‚


## å¹¿æ’­è§„åˆ™

1. **ç»´åº¦å¯¹é½**ï¼šä»æœ€å³è¾¹å¼€å§‹é€ç»´æ¯”è¾ƒ
2. **å…¼å®¹æ¡ä»¶**ï¼š
   - ç»´åº¦ç›¸ç­‰ âœ…
   - å…¶ä¸­ä¸€ä¸ªä¸º1 âœ…
3. **æ‰©å±•è§„åˆ™**ï¼šå¤§å°ä¸º1çš„ç»´åº¦ä¼šè¢«å¤åˆ¶æ‰©å±•
4. **ä¸å…¼å®¹æƒ…å†µ**ï¼šå…¶ä»–æ‰€æœ‰æƒ…å†µéƒ½ä¼šæŠ¥é”™ âŒ

---

## ç¼–ç å™¨çš„maskå¹¿æ’­è®¡ç®—

ç¼–ç å™¨ä¸­éœ€è¦å±è”½æ‰å¡«å……tokenï¼Œé¿å…å®ƒä»¬å‚ä¸æ³¨æ„åŠ›æƒé‡è®¡ç®—ï¼Œå‡è®¾ï¼š

- æ³¨æ„åŠ›æœºåˆ¶ä¸­Qå’ŒK_Tç‚¹ç§¯ç›¸ä¹˜åçš„ç»´åº¦å¤§å°æ˜¯ (2,2,5,5)ï¼Œç»´åº¦åˆ†åˆ«ä¸º[batch_size,head_num,seq_len,seq_len], ä¹Ÿå°±æ˜¯2ä¸ªå¥å­åºåˆ—ï¼Œ2ä¸ªå¤´ï¼Œæ¯ä¸ªå¥å­åºåˆ—çš„é•¿åº¦ä¸º5
- å‡è®¾ç¬¬1ä¸ªå¥å­åé¢2ä¸ªæ˜¯å¡«å……tokenï¼Œç¬¬2ä¸ªå¥å­åé¢1ä¸ªæ˜¯å¡«å……token

```python
import torch
scaled_matmul = torch.randint(10, 100, (2, 2, 5, 5))  # batch_size head_num seq_len seq_len

tensor([[[[83, 31, 34, 65, 28],
          [24, 86, 81, 58, 26],
          [36, 66, 87, 49, 50],
          [23, 39, 40, 16, 79],
          [80, 58, 47, 65, 73]],

         [[87, 64, 14, 94, 89],
          [14, 27, 66, 11, 49],
          [23, 45, 93, 25, 86],
          [97, 58, 17, 56, 50],
          [34, 32, 85, 62, 43]]],


        [[[14, 65, 52, 51, 26],
          [30, 16, 60, 40, 75],
          [44, 98, 54, 27, 39],
          [54, 66, 59, 72, 16],
          [29, 74, 76, 75, 80]],

         [[82, 96, 46, 78, 63],
          [46, 62, 19, 12, 77],
          [72, 87, 15, 49, 93],
          [63, 27, 13, 41, 55],
          [38, 73, 20, 44, 95]]]])



# åˆ¶ä½œæ©ç 
src = torch.ones(2, 5)

mask = src > 0

# ç¬¬1ä¸ªå¥å­åé¢2ä¸ªæ˜¯å¡«å……tokenï¼Œç¬¬2ä¸ªå¥å­åé¢1ä¸ªæ˜¯å¡«å……token
mask[0][3:] = False
mask[1][4:] = False

mask

tensor([[ True,  True,  True, False, False],
        [ True,  True,  True,  True, False]])

# å°†ç»´åº¦æ•°é‡æ•´ç†æˆä¸€è‡´
mask = mask.unsqueeze(1).unsqueeze(2)

mask.shape

torch.Size([2, 1, 1, 5])

# maskè®¡ç®—ï¼Œå°†maskä¸ºFalseçš„ä½ç½®å¡«å……ä¸ºæå°å€¼
scaled_matmul_mask = scaled_matmul.masked_fill(mask == False, float(1e-20))

scaled_matmul_mask
tensor(
    # è¿™æ˜¯ç¬¬ä¸€ä¸ªå¥å­çš„2ä¸ªå¤´
        [[[[83, 31, 34,  0,  0],
          [24, 86, 81,  0,  0],
          [36, 66, 87,  0,  0],
          [23, 39, 40,  0,  0],
          [80, 58, 47,  0,  0]],

         [[87, 64, 14,  0,  0],
          [14, 27, 66,  0,  0],
          [23, 45, 93,  0,  0],
          [97, 58, 17,  0,  0],
          [34, 32, 85,  0,  0]]],


    # è¿™æ˜¯ç¬¬äºŒä¸ªå¥å­çš„2ä¸ªå¤´
        [[[14, 65, 52, 51,  0],
          [30, 16, 60, 40,  0],
          [44, 98, 54, 27,  0],
          [54, 66, 59, 72,  0],
          [29, 74, 76, 75,  0]],

         [[82, 96, 46, 78,  0],
          [46, 62, 19, 12,  0],
          [72, 87, 15, 49,  0],
          [63, 27, 13, 41,  0],
          [38, 73, 20, 44,  0]]]])
```

#### å¹¿æ’­æ­¥éª¤è§£æï¼š

1. `mask` æ˜¯ä¸€ä¸ªå¸ƒå°”å¼ é‡ï¼Œshape ä¹Ÿæ˜¯ `[2, 1, 1, 5]`
2. `scaled_matmul` çš„ shape æ˜¯ `[2, 2, 5, 5]`
3. æ ¹æ®å¹¿æ’­è§„åˆ™ï¼š
   - æœ€å³è¾¹çš„ç»´åº¦éƒ½æ˜¯ 2 âœ…
   - å†å¾€å·¦æ˜¯ `1` vs `2`ï¼Œå…è®¸å¹¿æ’­ âœ…
   - å†å¾€å·¦æ˜¯ `1` vs `5`ï¼Œå…è®¸å¹¿æ’­ âœ…
   - æœ€å·¦è¾¹æ˜¯ `5` vs `5`ï¼ŒåŒ¹é… âœ…

å› æ­¤ï¼Œ`mask` è¢«å¹¿æ’­æˆ `[2, 2, 5, 5]`ï¼Œæ­£å¥½å’Œ `scaled_matmul` å¯¹åº”ä¸Šã€‚

---

#### ğŸ§® ç»“æœè§£é‡Š

- æ¯ä¸ª headã€æ¯ä¸ª query token éƒ½ä¼šçœ‹åˆ° key çš„æ‰€æœ‰ä½ç½®ã€‚
- mask åªå…³å¿ƒ key çš„å“ªäº›ä½ç½®æ˜¯ paddingã€‚
- æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æä¾›ä¸€ä¸ª `[B, 1, 1, T_k]` çš„ maskï¼Œå®ƒä¼šåœ¨ head å’Œ query ç»´åº¦ä¸Šå¹¿æ’­ã€‚
- è¿™æ ·å°±èƒ½æ­£ç¡®åœ°å±è”½æ‰æ‰€æœ‰å¤´ã€æ‰€æœ‰ query å¯¹ padding key çš„å…³æ³¨ã€‚

## è§£ç å™¨çš„maskå¹¿æ’­è®¡ç®—

è§£ç å™¨éœ€è¦å±å±è”½æ‰å½“å‰tokenæœªæ¥ä½ç½®

```python
# åˆ¶ä½œæ¯ä¸ªå¥å­éƒ½ä¼šç”¨åˆ°çš„ä¸‹ä¸‰è§’çŸ©é˜µï¼Œä¸‹ä¸‰è§’ä¸º1ï¼Œä¸Šä¸‰è§’ä¸º0

mask = torch.tril(torch.ones(5,5))

mask

tensor([[1., 0., 0., 0., 0.],
        [1., 1., 0., 0., 0.],
        [1., 1., 1., 0., 0.],
        [1., 1., 1., 1., 0.],
        [1., 1., 1., 1., 1.]])

mask = mask.expand(2, 1, 5, 5)

mask.shape

torch.Size([2, 1, 5, 5])

# å¼€å§‹è®¡ç®—mask
scaled_matmul_mask = scaled_matmul.masked_fill(mask == 0, float(1e-20))

scaled_matmul_mask

# å¯ä»¥çœ‹åˆ°å½“å‰tokenåªèƒ½çœ‹åˆ°ä¹‹å‰tokenäº†
tensor([[[[83,  0,  0,  0,  0],
          [24, 86,  0,  0,  0],
          [36, 66, 87,  0,  0],
          [23, 39, 40, 16,  0],
          [80, 58, 47, 65, 73]],

         [[87,  0,  0,  0,  0],
          [14, 27,  0,  0,  0],
          [23, 45, 93,  0,  0],
          [97, 58, 17, 56,  0],
          [34, 32, 85, 62, 43]]],


        [[[14,  0,  0,  0,  0],
          [30, 16,  0,  0,  0],
          [44, 98, 54,  0,  0],
          [54, 66, 59, 72,  0],
          [29, 74, 76, 75, 80]],

         [[82,  0,  0,  0,  0],
          [46, 62,  0,  0,  0],
          [72, 87, 15,  0,  0],
          [63, 27, 13, 41,  0],
          [38, 73, 20, 44, 95]]]])

```
